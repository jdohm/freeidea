<html>

<head>
    <title>FreeIdea</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/og.css" type="text/css" />
    <meta name="author" content="Jannis Dohm"><!-- based on openglobus.org -->
    <meta charset="UTF-8">
   <link rel="icon" type="image/svg+xml" href="./media/favicon.svg">
</head>

<body>
    <div id="earth" style="width:100%;height:100%"></div>
    <script type="module">
        'use strict';

        import { Globe } from './src/og/Globe.js';
        import { GlobusTerrain } from './src/og/terrain/GlobusTerrain.js';
        import { XYZ } from './src/og/layer/XYZ.js';
        import { WMS } from './src/og/layer/WMS.js';
        import { Vector } from './src/og/layer/Vector.js';
        import { Vec2 } from './src/og/math/Vec2.js';
        import { Entity } from './src/og/entity/Entity.js';
        import { IdeaEntity } from './src/og/IdeaEntity.js';
        import { Idea } from './src/og/Idea.js';

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var obj = JSON.parse(this.responseText);
                //Object.keys(this.responseText).forEach(key => {
                    //console.log(key, obj[key].LON);
                //});

                for (var key in obj) {
                    // skip loop if the property is from prototype
                    if (!obj.hasOwnProperty(key)) continue;

                    console.log('lon: ' + obj[key].LON + ' lat: ' + obj[key].LAT + ' IdeaID: ' + obj[key].IDEAID);
                    myCreateIdea(obj[key].LON, obj[key].LAT, obj[key].IDEAID);
                    }
            }
        };
        //xhttp.setRequestHeader("Accept", "application/json");
        //xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.open("GET", "getIdeas", true);
        xhttp.send();

	   function myCreateIdea(lon, lat, id){
         pointLayer.add(new IdeaEntity({
             'name': id,
             'lonlat': [lon, lat],
             'billboard': {
                 'src': './media/pos.png',
                 'size': [12, 48],
                 'offset': [0, 24]
             }
         }));
	   }

        let pointLayer = new Vector("points", {
            'clampToGround': true,
            'async': false
        });

        let pickingObject = null;
        let startClick = new Vec2(),
            startPos;

        pointLayer.events.on("mouseenter", function (e) {
            e.renderer.handler.canvas.style.cursor = "pointer";
        });

        pointLayer.events.on("mouseleave", function (e) {
            e.renderer.handler.canvas.style.cursor = "default";
        });

        pointLayer.events.on("ldown", function (e) {
            e.renderer.controls.mouseNavigation.deactivate();
            startClick.set(e.x, e.y);
            pickingObject = e.pickingObject;
            startPos = e.pickingObject.layer.planet.getPixelFromCartesian(pickingObject.getCartesian());
        });

        pointLayer.events.on("lup", function (e) {
            e.renderer.controls.mouseNavigation.activate();
            pickingObject = null;
        });

        let osm = new XYZ("OSM", {
            'specular': [0.0003, 0.00012, 0.00001],
            'shininess': 20,
            'diffuse': [0.89, 0.9, 0.83],
            'isBaseLayer': true,
            'url': "//b.tile.openstreetmap.org/{z}/{x}/{y}.png",
            'visibility': true,
            'attribution': 'Data @ OpenStreetMap contributors, ODbL'
        });

        let globe = new Globe({
            "target": "earth",
            "name": "Earth",
            "terrain": new GlobusTerrain(),
            "layers": [osm, pointLayer]
        });

        globe.planet.renderer.events.on("mousemove", function (e) {
            if (pickingObject) {
                var d = new Vec2(e.x, e.y).sub(startClick);
                var endPos = startPos.add(d);
                var coords = this.getCartesianFromPixelTerrain(endPos);
                if (coords) {
                    pickingObject.setCartesian3v(coords);
                }
            }
        }, globe.planet);

        let myIdea = new Idea({
            planet: globe.planet,
            offset: [0, -235],
            visibility: false
        });

	function myFunction(){
            myIdea.setVisibility(true);
	}

	function myHideFunction(){
            myIdea.setVisibility(false);
	}

	function myCreateIdeaFunction(ll){
            pointLayer.add(new Entity({
                'name': 'New Marker',
                'lonlat': ll,
                'billboard': {
                    'src': './media/pos.png',
                    'size': [12, 48],
                    'offset': [0, 24]
                }
            }));
	}

        globe.planet.viewExtentArr([8.08, 46.72, 8.31, 46.75]);

        globe.planet.renderer.events.on("lclick", function (e) {
            if (pickingObject) {
                //alert("name: " + e.pickingObject.properties.name);
                e.pickingObject.showIdea(globe.planet);
            //myIdea.setVisibility(true);
	    }
	    else {//New Idea
	//idea start
            var ll = globe.planet.getLonLatFromPixelTerrain(e, true);

            let groundPos = globe.planet.getCartesianFromMouseTerrain();
            myIdea.setCartesian3v(groundPos);

	    myIdea.setContent(``);
			    myIdea.setFunction(myCreateIdea, ll);
            myIdea.setVisibility(true);
	//idea end
	    }

        });

        pointLayer.events.on("rclick", function(e){
            e.pickingObject.remove();
        });


        window.p = pointLayer;

    </script>
</body>

</html>
